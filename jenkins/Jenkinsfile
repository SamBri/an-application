// Jenkinsfile (Declarative Pipeline)
pipeline {
   agent any
   
   stages {
      stage('Build') {
         steps {
            echo 'Building stage'
            sh 'mvn compile'
            sh 'mvn package'
            
         }
      }
      
      stage('Deploy') {
         when {
            expression {
               currentBuild.result == null || currentBuild.result == 'SUCCESS'
            }
         }
         
         environment {
            //    DEBUG_FLAGS = '-g'
            NAME = """${sh(
            returnStdout:true,
            script: 'mvn -q -DforceStdout help:evaluate -Dexpression=project.name'
            )}"""
            // mvn -q -DforceStdout help:evaluate -Dexpression=project.name
            VERSION =  """${sh(
            returnStdout: true,
            script:'mvn -q -DforceStdout help:evaluate -Dexpression=project.version'
            )}"""
            
            // get version
            //sh'set VERSION=`mvn -q -DforceStdout help:evaluate -Dexpression=project.version`'
         }
         
         // jenkins over ssh --
         steps {
            sh 'printenv'
            sh 'echo $NAME'
            sh 'echo $VERSION'
            echo 'delivering app for deployment.'
            sh 'scp ./target/$NAME-$VERSION.jar appuser@192.168.0.190:/home/appuser/apps/'
            sh 'ssh  appuser@192.168.0.190 "nohup java -jar /home/appuser/apps/$NAME-$VERSION.jar > /dev/null 2>&1 &"'
         }
         
         
      }
      
      
      stage('End') {
         steps {
            echo 'done with deployment'
            sh 'echo "done"'
            sh 'exit'  
         }
      }
      
   }
   
}